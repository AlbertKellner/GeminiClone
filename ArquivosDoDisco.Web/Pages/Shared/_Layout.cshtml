<html>
<head>
    <script src="https://unpkg.com/sunburst-chart"></script>
</head>
<body>
    @RenderBody()

    <form>
        <label for="getDisks">GetDisks:</label>
        <select id="getDisks" onchange="getStructure(this.value);">
            <!-- Dropdown options will be populated with JavaScript -->
        </select>
    </form>

    <div>
        <div class="chart" id="sunburstChart"></div>
    </div>

    <script>
        myChart = Sunburst();

        function fetchDisks() {
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    var disks = JSON.parse(xhr.responseText);
                    populateDropdown(disks);
                }
            };
            xhr.open("GET", "/api/Structure", true);
            xhr.send();
        }

        // JavaScript function to populate the dropdown with the fetched data
        function populateDropdown(disks) {
            var dropdown = document.getElementById("getDisks");

            var option = document.createElement("option");
            option.value = "";
            option.text = "";
            dropdown.add(option);

            for (var i = 0; i < disks.length; i++) {
                var option = document.createElement("option");
                option.value = disks[i];
                option.text = disks[i];
                dropdown.add(option);
            }
        }

        function getStructure(selectedDrive) {
            document.querySelector(".chart").innerHTML = "Loading...";

            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    var data = JSON.parse(xhr.responseText);
                    console.log(data);
                    generateGraph(data);
                }
            };
            xhr.open("GET", "/api/structure/" + selectedDrive.charAt(0), true);
            xhr.send();
        }

        function generateGraph(data) {
            //myChart = Sunburst();

            //data = {
            //    name: 'root',
            //    value: 900,
            //    children: [
            //        { name: 'child #1', value: 100 },
            //        { name: 'child #2', value: 300 },
            //        {
            //            name: 'child #3',
            //            value: 300,
            //            children: [
            //                { name: 'grandchild #1', value: 50 },
            //                { name: 'grandchild #2', value: 75 },
            //                { name: 'grandchild #3', value: 125 },
            //            ]
            //        }
            //    ]
            //};

            document.querySelector(".chart").innerHTML = "";
            
            removeValueIfChildren(data);

            myChart.data(data)(document.getElementById("sunburstChart"));
        }

        function removeValueIfChildren(node) {
            if (node.children) {
                delete node.value;

                node.children.forEach(removeValueIfChildren);
            }
        }

        fetchDisks();
    </script>
</body>
</html>